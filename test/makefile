# c++ compiler with flag to
# keep symbols.
CXX = clang++ -g

# c++11 compilance and dependency gen 
# and disable c++98 compilance
CXXFLAGS  = -std=c++11 -MMD -MP

INCLUDES=-isystem ../dep/decimal_for_cpp/include \
		 -isystem ./usr/include/ \
		 -I ../include/freedom \
		 -I ../dep/libmcts/include \
		 -I ../dep/libecalc/include \
		 -I ../dep/libpoker/include \

# add paths of libraries the
# targets depend on.
LIBRARIES = -L ../lib/$(target) -lfreedom \
			-L ../dep/libpoker/lib/$(target) -lpoker \
			-L ../dep/libecalc/lib/$(target) -lecalc \
			-L ../dep/libmcts/lib/$(target) -lmcts \
			-L /usr/lib/UnitTest++ -lUnitTest++ \
			-lpthread

# gather all source files and define
# where the object files of each target go.
CPP_FILES = $(wildcard *.cpp)
OBJ_FILES = $(addprefix obj/$(target)/,$(notdir $(CPP_FILES:.cpp=.o)))
DEP_FILES = $(OBJ_FILES:.o=.d)

ifeq ($(target),debug)
	CXXFLAGS +=-O0 -Weverything -Wno-c++98-compat
else
    target = release
	CXXFLAGS +=-O3 -Wall
endif

OUT_BIN = bin/$(target)/tests

# implict targets to build source files
obj/$(target)/%.o: %.cpp
	$(CXX) $(INCLUDES) $(CXXFLAGS) -c -o $@ $<

# link targets with their specific
# target options.
$(OUT_BIN): $(OBJ_FILES)
	$(CXX) $(INCLUDES) $(OBJ_FILES) $(LIBRARIES) -o $(OUT_BIN)

prepare:
	mkdir -p obj/{release,debug}
	mkdir -p bin/{release,debug}

run:
	./$(OUT_BIN)

# target cleans all files generated by 
# the buildprocess.
clean:
	rm -f $(OBJ_FILES)
	rm -f $(DEP_FILES)
	rm -f $(OUT_BIN)

all: prepare $(OUT_BIN) 

.PHONY: clean all run $(OUT_BIN)

-include $(DEP_FILES)
